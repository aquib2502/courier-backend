name: Deploy Courier Backend (Docker Compose)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 69.62.73.169
          username: deployer
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "========================================="
            echo "üöÄ Starting Deployment: Courier Backend"
            echo "========================================="

            BACKEND_DIR="/home/deployer/app/stack/courier-backend"
            STACK_DIR="/home/deployer/app/stack"
            SERVICE="courier-backend"
            PROXY_NET="nginx-proxy-manager_default"

            echo "üìÅ Moving to backend directory: $BACKEND_DIR"
            cd $BACKEND_DIR || { echo "Backend directory missing"; exit 1; }

            echo "üì• Fetching and resetting to latest commit..."
            git fetch --all
            git reset --hard origin/main

            echo "üì¶ Moving to Docker Compose directory: $STACK_DIR"
            cd $STACK_DIR || { echo "Stack directory missing"; exit 1; }

            echo "‚õî Stopping running container (if any)..."
            docker compose stop $SERVICE || true

            echo "üßπ Removing old container..."
            docker compose rm -f $SERVICE || true

            echo "üê≥ Building new Docker image for $SERVICE..."
            docker compose build $SERVICE

            echo "üîÅ Starting updated container..."
            docker compose up -d $SERVICE

            echo "üîç Checking reverse proxy network attachment..."
            if docker network inspect $PROXY_NET | grep -q "$SERVICE"; then
              echo "‚úî $SERVICE is already connected to $PROXY_NET"
            else
              echo "üîó Connecting $SERVICE to $PROXY_NET..."
              docker network connect $PROXY_NET $SERVICE || echo "‚ö† Could not connect (already attached or network issue)"
            fi

            echo "-----------------------------------------"
            echo "üü¢ Deployment Completed Successfully!"
            echo "-----------------------------------------"
